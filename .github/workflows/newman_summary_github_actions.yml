# N√ÅZEV WORKFLOW - bude se zobrazovat v seznamu workflow v GitHub Actions
name: Newman with Summary in GitHub Actions
# Manu√°ln√≠ spu≈°tƒõn√≠ workflow p≈ôes GitHub Actions UI
on: workflow_dispatch
# Joby (√∫lohy) kter√© se maj√≠ spustit - job funguje jako samostatn√Ω skript, m≈Ø≈æeme takto rozdƒõlit workflow na v√≠ce ƒç√°st√≠ (nap≈ô√≠klad: p≈ô√≠prava prost≈ôed√≠, testy, √∫klid prost≈ôed√≠, reporting, ...)
jobs:
  # N√ÅZEV JOBU - bude se zobrazovat v seznamu job≈Ø v r√°mci workflow
  newman_tests:
    # Maxim√°ln√≠ doba bƒõhu jobu v minut√°ch (abychom nekonecne neƒçekali na dokonƒçen√≠), pom≈Ø≈æe se vyvarovat √∫ƒçtov√°n√≠ za zbyteƒçnƒõ dlouh√Ω bƒõh
    timeout-minutes: 5
    # V jak√©m prost≈ôed√≠ se m√° job spustit - Pou≈æijeme Ubuntu (Linux) - nejv√Ωhodnƒõj≈°√≠ v GitHub Actions a efektivn√≠ pro vƒõt≈°inu p≈ô√≠pad≈Ø pou≈æit√≠
    runs-on: ubuntu-latest
    # Kroky (steps) kter√© se maj√≠ v r√°mci jobu spustit - kroky jsou jednotliv√© p≈ô√≠kazy nebo akce, kter√© se vykonaj√≠ v r√°mci jobu
    steps:
      # Checkout repository - z√°kladn√≠ krok pro z√≠sk√°n√≠ k√≥du z repozit√°≈ôe
      - uses: actions/checkout@v6
      # Instalace Node.js prost≈ôed√≠ - pot≈ôebujeme pro bƒõh Newman
      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: lts/*
      # Instalace z√°vislost√≠ - nainstalujeme v≈°echny knihovny pot≈ôebn√© pro bƒõh Newman
      - name: Install dependencies
        run: npm ci
      # Spu≈°tƒõn√≠ Newman test≈Ø - s continue-on-error aby workflow pokraƒçoval i p≈ôi selh√°n√≠ test≈Ø
      - name: Run Newman tests
        continue-on-error: true
        run: npx newman run "./collections/Newman Failing Tests.postman_collection.json" -r cli,json --reporter-json-export newman/newman-run-report.json
      # Generov√°n√≠ Newman Summary do GitHub Actions Summary
      - name: Generate Newman Summary
        if: ${{ !cancelled() }}
        run: |
          node -e '
          const fs = require("fs");

          try {
            // Naƒçten√≠ JSON reportu z Newman
            const report = JSON.parse(fs.readFileSync("newman/newman-run-report.json", "utf8"));
            const stats = report.run.stats;
            const timings = report.run.timings;
            
            // Funkce pro urƒçen√≠ emoji podle stavu
            function getEmoji(stat) {
              if (stat.pending > 0) return "üü†";
              if (stat.failed > 0) return "üî¥";
              return "üü¢";
            }
            
            // Vytvo≈ôen√≠ markdown tabulky
            let summary = "## Newman Test Summary\n\n";
            summary += "| | Executed | Failed |\n";
            summary += "|---|---|---|\n";
            summary += `| ${getEmoji(stats.iterations)} iterations | ${stats.iterations.total} | ${stats.iterations.failed} |\n`;
            summary += `| ${getEmoji(stats.requests)} requests | ${stats.requests.total} | ${stats.requests.failed} |\n`;
            summary += `| ${getEmoji(stats.testScripts)} test-scripts | ${stats.testScripts.total} | ${stats.testScripts.failed} |\n`;
            summary += `| ${getEmoji(stats.prerequestScripts)} prerequest-scripts | ${stats.prerequestScripts.total} | ${stats.prerequestScripts.failed} |\n`;
            summary += `| ${getEmoji(stats.assertions)} assertions | ${stats.assertions.total} | ${stats.assertions.failed} |\n`;
            
            // P≈ôid√°n√≠ ƒçasov√Ωch informac√≠
            const duration = timings.completed - timings.started;
            const avgResponse = timings.responseAverage;
            summary += `\n**Total run duration:** ${duration}ms\n`;
            summary += `**Average response time:** ${avgResponse}ms\n`;
            
            // Z√°pis do GitHub Actions Summary
            fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, summary);
            
          } catch (error) {
            // Zobrazen√≠ chyby pokud se nepoda≈ô√≠ naƒç√≠st nebo zpracovat report
            const errorMsg = `## ‚ùå Newman Summary Generation Failed\n\n**Error:** ${error.message}\n`;
            fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, errorMsg);
          }
          '
